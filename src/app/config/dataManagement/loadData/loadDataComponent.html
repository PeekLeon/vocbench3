<div class="card card-default vbox">
    <div class="card-header">
        <label style="flex: 1;">Load Data:</label>
        <div class="btn-toolbar" role="toolbar">
            <div class="btn-group btn-group-xs">
                <button class="btn btn-light" title="Save import configuration" (click)="saveChain()">
                    <span class="fas fa-download"></span>
                </button>
                <button class="btn btn-light" title="Load import configuration" (click)="loadChain()">
                    <span class="fas fa-upload"></span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="card-body vbox">
        <div class="card card-alt">
            <div class="card-header">
                <label style="margin-right: 8px">Load from:</label>
                <select class="form-control form-control-sm" style="width: initial" [(ngModel)]="selectedLoader">
                    <option *ngFor="let loaderOpt of loaderOptions" [ngValue]="loaderOpt">{{loaderOpt.label}}</option>
                </select>
            </div>
            <div class="card-body">

                <!-- File selection available only when there is no target loader -->
                <div class="form-group row" *ngIf="!selectedLoader.target">
                    <label class="col-form-label col-sm-1">File:</label>
                    <div class="col-sm-11">
                        <file-picker (fileChanged)="fileChangeEvent($event)" [accept]="filePickerAccept"></file-picker>    
                    </div>
                </div>

                <!-- Dataset catalog -->
                <div class="form-group row" *ngIf="selectedLoader.target == 'datasetCatalog'">
                    <label class="col-form-label col-sm-1">Data dump:</label>
                    <div class="col-sm-5">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" [(ngModel)]="dataDumpUrl" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-light" (click)="loadFromDatasetCatalog()">
                                    <span class="fas fa-pencil-alt"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <label class="col-form-label col-sm-1">Format:</label>
                    <div class="col-sm-5">
                        <ng-container *ngTemplateOutlet="formatSelectionTemplate"></ng-container>
                    </div>
                </div>

                <!-- Loader available only When a target (repo or stream) is specified -->
                <div class="form-group row" *ngIf="showLoader()">
                    <label class="col-form-label col-sm-1">Loader:</label>
                    <div class="col-sm-11">
                        <ng-template [ngIf]="selectedLoader.target == 'repository'">
                            <extension-configurator #loaderConfigurator *ngIf="repoTargetLoaders" [extensions]="repoTargetLoaders"
                                (extensionUpdated)="selectedLoaderExtension = $event"
                                (configurationUpdated)="selectedLoaderConfig = $event"
                                (configStatusUpdated)="onLoaderConfigStatusUpdated($event)"
                                style="flex: 1;">
                            </extension-configurator>
                        </ng-template>
                        <ng-template [ngIf]="selectedLoader.target == 'stream'">
                            <extension-configurator #loaderConfigurator *ngIf="streamTargetLoaders" [extensions]="streamTargetLoaders"
                                (extensionUpdated)="selectedLoaderExtension = $event"
                                (configurationUpdated)="selectedLoaderConfig = $event"
                                (configStatusUpdated)="onLoaderConfigStatusUpdated($event)"
                                style="flex: 1;">
                            </extension-configurator>
                        </ng-template>
                    </div>
                </div>

                <!-- Lifter available only when there is no target (load from file) or a stream-target loader -->
                <div class="form-group row" *ngIf="!selectedLoader.target || selectedLoader.target == 'stream'">
                    <label class="col-form-label col-sm-1">RDF Lifter:</label>
                    <div class="col-sm-5">
                        <extension-configurator *ngIf="lifters" [extensions]="lifters"
                            (extensionUpdated)="onLifterExtensionUpdated($event)"
                            (configurationUpdated)="selectedLifterConfig = $event">
                        </extension-configurator>
                    </div>
                    <label class="col-form-label col-sm-1">Format:</label>
                    <div class="col-sm-5">
                        <ng-container *ngTemplateOutlet="formatSelectionTemplate"></ng-container>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-form-label col-sm-1">Base URI:</label>
                    <div class="col-sm-3">
                        <input type="text" class="form-control" [(ngModel)]="baseURI" placeholder="http://example.baseuri.com/" [disabled]="useProjectBaseURI">
                    </div>
                    <div class="col-sm-2 d-flex align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" [(ngModel)]="useProjectBaseURI" (ngModelChange)="onBaseUriChecboxChange()">
                            <label class="form-check-label">Use project baseURI</label>
                        </div>
                    </div>
                    <label class="col-form-label col-sm-1">
                        Resolve imports:
                        <span class="fas fa-info-circle" title="Specify the resolution source in case of transitive imports"></span>
                    </label>
                    <div class="col-sm-5">
                        <select class="form-control" [(ngModel)]="selectedImportAllowance">
                            <option *ngFor="let ia of importAllowances" [value]="ia.allowance">{{ia.show}}</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>

        <div class="card card-alt vbox" style="flex: 2; margin-top: 4px;">
            <div class="card-header">
                <label style="flex: 1">Import transformations:</label>
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group btn-group-xs">
                        <button class="btn btn-light" title="Add transformer" (click)="appendTransformer()">
                            <span class="fas fa-plus"></span>
                        </button>
                        <button class="btn btn-light" title="Remove transformer" (click)="removeTransformer()"
                            [disabled]="transformersChain.length == 0 || !selectedTransformerChainElement">
                            <span class="fas fa-minus"></span>
                        </button>
                        <button class="btn btn-light" title="Move down"  (click)="moveTransformerDown()"
                            [disabled]="isSelectedTransformerLast() || !selectedTransformerChainElement">
                            <span class="fas fa-chevron-down"></span>
                        </button>
                        <button class="btn btn-light" title="Move up" (click)="moveTransformerUp()"
                            [disabled]="isSelectedTransformerFirst() || !selectedTransformerChainElement">
                            <span class="fas fa-chevron-up"></span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body scrollableContainer">
                <div class="alert alert-info alert-dismissible" role="alert" style="margin-bottom: 5px;">
                    Here it is possible to create and configure a sequence of transformers to be applied during the import process.
                    <button class="close" data-dismiss="alert"><span>&times;</span></button>
                </div>
                <table class="table table-sm table-hoverable">
                    <colgroup>
                        <col style="width: 2%">
                        <col>
                        <col style="width: 2%">
                    </colgroup>
                    <tbody>
                        <tr *ngFor="let transformerChainEl of transformersChain; let l = last; let f = first; let idx = index" 
                            [ngClass]="{'table-primary': transformerChainEl == selectedTransformerChainElement}" (click)="selectTransformerChainElement(transformerChainEl)">
                            <td class="text-center" style="font-size: 11px; font-weight: 700;">{{idx+1}}</td>
                            <td>
                                <extension-configurator [extensions]="transformerChainEl.availableFactories"
                                    (extensionUpdated)="onExtensionUpdated(transformerChainEl, $event)"
                                    (configurationUpdated)="onConfigurationUpdated(transformerChainEl, $event)" 
                                    (configStatusUpdated)="onConfigStatusUpdated(transformerChainEl, $event)">
                                </extension-configurator>
                            </td>
                            <td class="text-center" style="font-size: 14px; font-weight: 700;">
                                <span *ngIf="requireConfiguration(transformerChainEl)" class="fas fa-exclamation-triangle"
                                    title="This transformer needs to be configured"></span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="card-footer d-flex align-items-center">
        <div *ngIf="isValidationEnabled()" class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox"  [(ngModel)]="validateImplicitly" [disabled]="!isValidationAuthorized()">
            <label class="form-check-label">Implicitly validate loaded data</label>
        </div>
        <span style="flex: 1"></span>
        <div class="float-right">
            <button type="submit" class="btn btn-light btn-sm" (click)="load()" [disabled]="isDataValid()">Submit</button>
        </div>
    </div>
</div>

<ng-template #formatSelectionTemplate>
    <div class="hbox" style="align-items: center;">
        <ng-container *ngIf="!selectedInputFormat && !forceFormat; then unkownFormatBlock; else selectFormatBlock"></ng-container>
        <ng-template #unkownFormatBlock>
            <select class="form-control" disabled>
                <option>Detect Format</option>
            </select>
        </ng-template>
        <ng-template #selectFormatBlock>
            <select class="form-control" [(ngModel)]="selectedInputFormat" [disabled]="!forceFormat">
                <option *ngFor="let f of inputFormats" [ngValue]="f">{{f.name}}</option>    
            </select>
        </ng-template>
        <div class="form-check ml-3">
            <input class="form-check-input" type="checkbox" [(ngModel)]="forceFormat">
            <label class="form-check-label text-nowrap">
                Force format
                <span class="fas fa-info-circle ml-2" title="Allows forcing the selection of a format overriding the one detected by the system"></span>
            </label>
        </div>
    </div>
</ng-template>